<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Review Kualitas Sampel Karung</title>
    <!-- Memuat Tailwind CSS untuk styling modern dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue background */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-3xl">
        <header class="mb-8 border-b-4 border-blue-600 pb-4">
            <h1 class="text-4xl font-black text-gray-800">
                Formulir Penilaian Kualitas Sampel Karung Terigu
            </h1>
            <p class="text-gray-600 mt-2">
                Lengkapi ulasan dengan skor dan rekomendasi untuk sampel yang diperiksa.
            </p>
            <!-- INDIKATOR STATUS SISTEM (BARU) -->
            <div id="systemStatus" class="text-sm text-center text-yellow-800 p-2 bg-yellow-100 rounded-lg mt-4 shadow-md">
                Sistem sedang menyiapkan koneksi Firebase... Harap tunggu sebentar.
            </div>
        </header>

        <!-- Form Utama -->
        <form id="reviewForm" class="space-y-12">

            <!-- BAGIAN HEADER/METADATA BARU -->
            <section id="metadataInputs" class="space-y-4 p-6 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
                <h2 class="text-xl font-extrabold text-gray-700">Detail Sampel</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Produk -->
                    <div>
                        <label for="product_name" class="block text-sm font-medium text-gray-700 mb-1">Produk</label>
                        <input type="text" id="product_name" name="product_name" required placeholder="Nama Produk Karung"
                               class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Supplier/Pencetak -->
                    <div>
                        <label for="supplier_name" class="block text-sm font-medium text-gray-700 mb-1">Supplier/Pencetak</label>
                        <input type="text" id="supplier_name" name="supplier_name" required placeholder="Nama Supplier atau Pencetak"
                               class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Tanggal Penerimaan Sampel -->
                    <div>
                        <label for="sample_date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Penerimaan Sampel</label>
                        <input type="date" id="sample_date" name="sample_date" required
                               class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Reviewer (Nama Orang yang Review) -->
                    <div>
                        <label for="reviewer_name" class="block text-sm font-medium text-gray-700 mb-1">Reviewer</label>
                        <input type="text" id="reviewer_name" name="reviewer_name" required placeholder="Nama Anda"
                               class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </section>
            <!-- AKHIR BAGIAN HEADER/METADATA -->

            <!-- KATEGORI I: REVIEW VISUAL -->
            <section class="space-y-6 p-6 border border-gray-200 rounded-xl shadow-lg bg-white">
                <h2 class="text-2xl font-extrabold text-blue-700 border-b pb-2">
                    I. Review Visual dan Teknis Kemasan
                </h2>

                <!-- Bagian A, B, C akan menggunakan fungsi generateReviewItem -->
                <div id="visualReviewItems" class="space-y-6">
                    <!-- Item Review akan dimasukkan di sini oleh JS -->
                </div>

            </section>
            
            <!-- KATEGORI II: KELENGKAPAN DOKUMEN -->
            <section class="space-y-4 pt-6 border-t border-gray-300">
                <h2 class="text-2xl font-extrabold text-green-700 border-b pb-2">
                    II. Kelengkapan Dokumen
                </h2>
                
                <div class="p-6 bg-green-50 rounded-xl shadow-md border-2 border-green-200">
                    <h3 class="font-bold text-lg text-green-800 mb-3">8. Kelengkapan Dokumen COA (Certificate of Analysis)</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Status Kelengkapan -->
                        <div>
                            <label for="doc_coa_status" class="block text-sm font-medium text-gray-700 mb-1">Status Dokumen</label>
                            <select id="doc_coa_status" name="doc_coa_status" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                                <option value="Ada">Ya</option>
                                <option value="Tidak Ada">Tidak</option>
                            </select>
                        </div>
                        
                        <!-- Catatan -->
                        <div class="md:col-span-2">
                            <label for="doc_coa_notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                            <textarea id="doc_coa_notes" name="doc_coa_notes" rows="2" placeholder="Catatan terkait COA (Opsional)" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                        </div>
                    </div>
                </div>

            </section>

            <!-- CARD SKOR RATA-RATA -->
            <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-lg shadow-xl flex justify-between items-center transition duration-300 hover:bg-blue-100 mx-auto max-w-full">
                <p class="text-lg font-bold text-blue-800">TOTAL NILAI RATA-RATA (Bagian I):</p>
                <span id="averageScoreDisplay" class="text-4xl font-extrabold text-blue-900 bg-white px-4 py-2 rounded-lg shadow-inner min-w-[120px] text-right">0.00</span>
            </div>


            <!-- KATEGORI III: REKOMENDASI DAN TINDAK LANJUT -->
            <section class="space-y-4 pt-6 border-t border-gray-300">
                <h2 class="text-2xl font-extrabold text-orange-700 border-b pb-2">
                    III. Rekomendasi & Tindak Lanjut
                </h2>

                <div class="p-6 bg-orange-50 rounded-xl shadow-md border-2 border-orange-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Rekomendasi (Dropdown) -->
                        <div>
                            <label for="recommendation_status" class="block text-sm font-medium text-gray-700 mb-1">Rekomendasi</label>
                            <select id="recommendation_status" name="recommendation" required
                                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 bg-white">
                                <option value="" disabled selected>-- Pilih Tindak Lanjut --</option>
                                <option value="Lolos">Lolos</option>
                                <option value="Diterima dengan catatan">Diterima dengan catatan</option>
                                <option value="Revisi">Revisi</option>
                                <option value="Tolak">Tolak</option>
                            </select>
                        </div>
                        
                        <!-- Catatan -->
                        <div class="md:col-span-2">
                            <label for="recommendation_notes" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Tindak Lanjut</label>
                            <textarea id="recommendation_notes" name="recommendation_notes" rows="2" placeholder="Deskripsi tindak lanjut atau catatan spesifik" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Tombol Kirim -->
            <button type="submit" id="submitButton" disabled class="w-full bg-gray-400 text-white font-bold py-3 rounded-xl mt-8 cursor-not-allowed">
                KIRIMKAN REVIEW & SIMPAN DATA
            </button>
        </form>

        <!-- Area Pesan/Output -->
        <div id="outputMessage" class="hidden mt-8 p-4 bg-green-100 text-green-700 rounded-xl font-semibold border border-green-300 shadow-inner">
            <!-- Pesan sukses atau error akan ditampilkan di sini -->
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // KONFIGURASI PENTING (HARAP GANTI PLACEHOLDER INI)
        // =========================================================================
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCs585ga4gFHMMqP-QUFvnWi-SleW3L1sg",
            authDomain: "reviewlog-90ece.firebaseapp.com",
            projectId: "reviewlog-90ece",
            storageBucket: "reviewlog-90ece.firebasestorage.app",
            messagingSenderId: "817094832497",
            appId: "1:817094832497:web:24f99fb36b3e1883f9c6d0",
            
            // URL WEB APP GAS GOOGLE SHEET (MASIH BERMASALAH, JANGAN DIUBAH DULU)
            googleSheetWebAppUrl: "https://script.google.com/macros/s/AKfycbyvH6ihucsb78Uveat7Uzd2ITd-FX0AobcP84S6XSx_9CD7fBJcMJglKa52-bTy8KUa/exec", 

            // URL WEB APP GAS BARU UNTUK GOOGLE DOCS (DIPEROLEH DARI LANGKAH 1)
            googleDocWebAppUrl: "https://script.google.com/macros/s/AKfycbzEgybvBK2h0KutOUf2iWgHD92AQsndCvge6VqP_O9uXKBl7TAkFQkCbDLbc5axMXAY/exec", 
        };
        // =========================================================================
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MY_FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : MY_FIREBASE_CONFIG.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let db, auth, userId = null;

        // Mendapatkan referensi ke elemen baru
        const submitButton = document.getElementById('submitButton');
        const systemStatus = document.getElementById('systemStatus');


        // Array yang berisi semua item review visual
        const visualItems = [
            { id: 'design_fit', num: '1.', group: 'A. DESAIN & KUALITAS CETAK', name: 'Kesesuaian Desain', criteria: 'Perbandingan langsung sampel fisik terhadap file artwork desain yang disetujui (posisi logo, elemen, tata letak).' },
            { id: 'print_quality', num: '2.', group: 'A. DESAIN & KUALITAS CETAK', name: 'Kualitas Cetak', criteria: 'Ketajaman hasil cetak/objek/teks, tidak ada cacat cetak (smudge, dot gain, miring, bergelombang).' },
            
            { id: 'text_fit', num: '3.', group: 'B. TEXT (Tulisan)', name: 'Kesesuaian Teks & Angka', criteria: 'Semua tulisan (informasi produk, berat, izin, dll.) dan angka dicetak sesuai draf akhir.' },
            { id: 'readability', num: '4.', group: 'B. TEXT (Tulisan)', name: 'Keterbacaan (Legibility)', criteria: 'Tulisan mudah terbaca, teks dan angka tercetak baik tidak menempel dengan kiri kanannya atau terdistorsi.' },
            
            { id: 'color_std', num: '5.', group: 'C. TONE WARNA (COLOR MATCHING)', name: 'Tone Warna Standard', criteria: 'Warna standar dibandingkan dengan sampel fisik/standar warna yang disetujui (mid-tone) untuk semua elemen cetak dan dasar karung.' },
            { id: 'color_min', num: '6.', group: 'C. TONE WARNA (COLOR MATCHING)', name: 'Toleransi Tone Minimum', criteria: 'Warna elemen cetak atau dasar harus berada di atas tone warna minimum yang masih dapat diterima (tidak terlalu pudar/terang).' },
            { id: 'color_max', num: '7.', group: 'C. TONE WARNA (COLOR MATCHING)', name: 'Toleransi Tone Maksimum', criteria: 'Warna elemen cetak atau dasar harus berada di bawah tone warna maksimum yang masih dapat diterima (tidak terlalu pekat/gelap).' },
        ];

        const visualReviewContainer = document.getElementById('visualReviewItems');
        const reviewForm = document.getElementById('reviewForm');
        const outputMessage = document.getElementById('outputMessage');
        let currentGroup = '';

        // FUNGSI 1: Membuat elemen HTML untuk setiap item review
        function generateReviewItem(item) {
            let html = '';
            
            if (item.group !== currentGroup) {
                if (currentGroup !== '') {
                    html += '<div class="mt-6 border-t-2 border-dashed border-blue-200 pt-4"></div>';
                }
                html += `<h3 class="text-xl font-bold text-gray-700 mb-3">${item.group}</h3>`;
                currentGroup = item.group;
            }

            html += `
                <div class="p-4 bg-white rounded-xl shadow-md border border-gray-100 transition duration-150 hover:shadow-lg">
                    <h4 class="font-bold text-base text-gray-800 mb-1">${item.num} ${item.name}</h4>
                    <p class="text-xs text-gray-500 mb-4 italic">Kriteria Pengukuran: ${item.criteria}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        
                        <!-- Kolom Rating (Nilai Aktual 1-5) -->
                        <div class="col-span-full md:col-span-3">
                            <label for="${item.id}_rating" class="block text-sm font-medium text-gray-700 mb-1">Nilai Aktual (1-5)</label>
                            <select id="${item.id}_rating" name="${item.id}_rating" required 
                                    class="rating-select w-full p-2.5 border border-blue-400 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
                                <option value="" disabled selected>Pilih Skor</option>
                                <option value="5">5 - Sangat Baik</option>
                                <option value="4">4 - Baik</option>
                                <option value="3">3 - Cukup</option>
                                <option value="2">2 - Buruk</option>
                                <option value="1">1 - Sangat Buruk</option>
                            </select>
                        </div>

                        <!-- Kolom Status (Sesuai/Mendekati/Tidak Sesuai) -->
                        <div class="col-span-full md:col-span-3">
                            <label for="${item.id}_status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="${item.id}_status" name="${item.id}_status" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
                                <option value="Sesuai">Sesuai</option>
                                <option value="Mendekati">Mendekati</option>
                                <option value="Tidak Sesuai">Tidak Sesuai</option>
                            </select>
                        </div>

                        <!-- Kolom Catatan -->
                        <div class="col-span-full md:col-span-6">
                            <label for="${item.id}_notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                            <textarea id="${item.id}_notes" name="${item.id}_notes" rows="1" placeholder="Catatan spesifik untuk item ini" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"></textarea>
                        </div>

                    </div>
                </div>
            `;
            return html;
        }
        
        // FUNGSI 2: Menghitung dan memperbarui skor rata-rata secara real-time
        function updateAverageScore() {
            const ratingInputs = document.querySelectorAll('.rating-select');
            let totalScore = 0;

            ratingInputs.forEach(select => {
                const value = parseInt(select.value); 
                if (!isNaN(value) && value >= 1 && value <= 5) {
                    totalScore += value;
                }
            });

            // Total divisor adalah 7 karena ada 7 item visual
            const divisor = visualItems.length; 
            const averageScore = divisor > 0 ? (totalScore / divisor) : 0;
            
            // Perbarui tampilan UI
            document.getElementById('averageScoreDisplay').textContent = averageScore.toFixed(2);
            
            // Mengubah warna skor berdasarkan nilainya
            const scoreDisplay = document.getElementById('averageScoreDisplay');
            scoreDisplay.className = 'text-4xl font-extrabold px-4 py-2 rounded-lg shadow-inner min-w-[120px] text-right bg-white';
            if (averageScore >= 4.0) {
                scoreDisplay.classList.add('text-green-600');
            } else if (averageScore >= 2.5) {
                scoreDisplay.classList.add('text-yellow-600');
            } else {
                scoreDisplay.classList.add('text-red-600');
            }
            
            return averageScore; // Kembalikan nilai rata-rata
        }

        // FUNGSI 3: Inisialisasi Firebase dan Otentikasi
        async function initializeFirebaseAndAuth() {
            
            // 1. Memuat semua item review visual
            visualReviewContainer.innerHTML = visualItems.map(generateReviewItem).join('');
            
            // 2. Pasang listener untuk pembaruan skor real-time
            document.querySelectorAll('.rating-select').forEach(select => {
                select.addEventListener('change', updateAverageScore);
            });
            
            // Panggil sekali untuk memastikan tampilan skor awal
            updateAverageScore();
            
            // 3. Pasang listener untuk pengiriman formulir
            reviewForm.addEventListener('submit', handleSubmit);
            
            // Tampilkan status loading awal dan nonaktifkan tombol
            systemStatus.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');

            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Kesalahan: Konfigurasi Firebase tidak ada.");
                outputMessage.textContent = "Peringatan: Konfigurasi Firebase TIDAK LENGKAP.";
                outputMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'border-green-300');
                outputMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                
                systemStatus.textContent = "Koneksi Firebase GAGAL: Konfigurasi tidak lengkap.";
                systemStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                systemStatus.classList.add('bg-red-100', 'text-red-800');
                
                return;
            }

            try {
                setLogLevel('debug'); // DI AKTIFKAN UNTUK MENDAPATKAN DETAIL ERROR!
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Otentikasi
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        if (unsubscribe) unsubscribe(); 
                        reject(new Error("Firebase initialization timed out."));
                    }, 10000); 

                    let unsubscribe; 
                    
                    unsubscribe = onAuthStateChanged(auth, (user) => {
                        clearTimeout(timeout);
                        unsubscribe(); 
                        
                        if (user) {
                            userId = user.uid;
                            submitButton.disabled = false;
                            submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-xl');
                            systemStatus.classList.add('hidden');
                            console.log("Firebase Auth berhasil. User ID:", userId);
                            resolve(); 
                        } else {
                            userId = auth.currentUser?.uid || `anon-${crypto.randomUUID()}`;
                            resolve(); 
                        }
                    });
                });
                
            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase atau otentikasi:", error);
                systemStatus.textContent = `Gagal menyambung: ${error.message}. Lihat konsol.`;
                systemStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                systemStatus.classList.add('bg-red-100', 'text-red-800');
                submitButton.disabled = true;
            }
        }

        // FUNGSI 4: Memanggil Web App Google Docs
        async function generateGoogleDoc(data) {
            const docUrl = firebaseConfig.googleDocWebAppUrl;
            let docSuccess = false;
            let finalDocLink = null;

            if (docUrl && docUrl !== "GANTI_DENGAN_URL_WEB_APP_DOCS_ANDA") {
                try {
                    console.log('Mencoba membuat Google Doc via Web App:', docUrl);
                    
                    // Mode no-cors tidak diperlukan karena GAS Web App merespons dengan JSON (ContentService)
                    const response = await fetch(docUrl, {
                        method: 'POST',
                        // TIDAK menggunakan mode: 'no-cors' agar dapat membaca respon status dan JSON
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data) 
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.docUrl) {
                            docSuccess = true;
                            finalDocLink = result.docUrl;
                            console.log("Google Doc berhasil dibuat! URL:", finalDocLink);
                        } else {
                            console.error("GAS Docs merespons sukses HTTP tetapi gagal di sisi server. Error GAS:", result.error);
                        }
                    } else {
                        console.error("Gagal koneksi ke Web App Docs. Status HTTP:", response.status);
                    }
                } catch (e) {
                    console.error("Kesalahan Jaringan saat mengirim data ke Web App Docs:", e);
                }
            } else {
                console.warn("Peringatan: URL Web App Google Docs belum dikonfigurasi. Dokumen tidak dibuat.");
            }
            return { docSuccess, finalDocLink };
        }


        // FUNGSI 5: Menangani Pengiriman Formulir dan Penyimpanan Data ke Firestore DAN Google Sheet
        async function handleSubmit(event) {
            event.preventDefault(); 
            
            if (!userId || !db) {
                console.error("Pengguna belum diautentikasi atau DB belum siap.");
                outputMessage.textContent = "Gagal mengirim: Harap tunggu sebentar sampai sistem siap atau muat ulang.";
                outputMessage.classList.remove('hidden');
                return;
            }

            // Atur tombol menjadi loading state
            submitButton.disabled = true;
            submitButton.textContent = "Memproses...";
            
            outputMessage.classList.add('hidden');

            const finalAverageScore = updateAverageScore(); // Hitung skor akhir sebelum pengiriman
            
            const formData = new FormData(reviewForm);
            
            // Kumpulkan data ke dalam objek yang akan dikirim ke Firebase dan GAS
            const reviewData = {
                productName: formData.get('product_name'),
                supplierName: formData.get('supplier_name'),
                sampleDate: formData.get('sample_date'),
                reviewerName: formData.get('reviewer_name'),
                
                timestamp: new Date().toISOString(), 
                reviewerId: userId,
                averageScore: finalAverageScore, // Sudah berupa float
                
                visualReview: [],
                
                documentReview: {
                    item: 'Kelengkapan Dokumen COA',
                    status: formData.get('doc_coa_status'),
                    notes: formData.get('doc_coa_notes')
                },

                recommendation: formData.get('recommendation'),
                recommendationNotes: formData.get('recommendation_notes')
            };

            visualItems.forEach(item => {
                const id = item.id;
                reviewData.visualReview.push({
                    item: item.name,
                    rating: parseInt(formData.get(`${id}_rating`)),
                    status: formData.get(`${id}_status`),
                    notes: formData.get(`${id}_notes`)
                });
            });

            // --- Mulai Proses Dual Save ---
            let firestoreSuccess = false;
            let docSuccess = false;
            let finalDocLink = null;
            let sheetSuccess = false;

            // 1. SIMPAN KE FIRESTORE (Sudah Berhasil)
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/sack_reviews`;
                await addDoc(collection(db, collectionPath), reviewData);
                firestoreSuccess = true;
                console.log('Data berhasil disimpan ke Firestore.');
            } catch (e) {
                console.error("Kesalahan saat menyimpan data ke Firestore: ", e);
            }

            // 2. BUAT GOOGLE DOC VIA WEB APP (Baru)
            if (firestoreSuccess) {
                const docResult = await generateGoogleDoc(reviewData);
                docSuccess = docResult.docSuccess;
                finalDocLink = docResult.finalDocLink;
            }
            
            // 3. SIMPAN KE GOOGLE SHEET VIA WEB APP (Dibiarkan tetap ada, mungkin akan berhasil)
            const gasSheetUrl = firebaseConfig.googleSheetWebAppUrl;
            if (gasSheetUrl && gasSheetUrl !== "GANTI_DENGAN_URL_WEB_APP_ANDA") {
                try {
                    // Masih menggunakan mode 'no-cors' untuk kompatibilitas yang lebih luas.
                    await fetch(gasSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        body: JSON.stringify(reviewData)
                    });
                    sheetSuccess = true; 
                } catch (e) {
                    console.error("Kesalahan Jaringan saat mengirim data ke Google Sheet:", e);
                }
            }


            // --- Tampilkan Pesan Akhir ---
            let message = "";
            let colorClass = "";

            if (firestoreSuccess && docSuccess) {
                message = `✅ REVIEW BERHASIL DISIMPAN! Dokumen Laporan: <a href="${finalDocLink}" target="_blank" class="text-blue-700 underline font-bold hover:text-blue-900">Lihat Google Doc</a>`;
                colorClass = 'bg-green-100 text-green-700 border-green-300';
            } else if (firestoreSuccess && !docSuccess) {
                message = `⚠️ REVIEW BERHASIL DISIMPAN ke Firebase, tetapi GAGAL membuat Google Doc. (Skor: ${finalAverageScore.toFixed(2)}). Cek log Apps Script Anda.`;
                colorClass = 'bg-yellow-100 text-yellow-700 border-yellow-300';
            } else {
                message = `❌ Gagal menyimpan data (Firebase dan Google Doc). Harap periksa koneksi atau konfigurasi Firebase.`;
                colorClass = 'bg-red-100 text-red-700 border-red-300';
            }
            
            if (sheetSuccess) {
                message += " (Pengiriman Google Sheet juga terdeteksi berhasil (via no-cors).)";
            }

            outputMessage.innerHTML = message;
            reviewForm.reset(); 
            updateAverageScore(); 
            
            outputMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-300', 'bg-green-100', 'text-green-700', 'border-green-300', 'bg-yellow-100', 'text-yellow-700', 'border-yellow-300');
            outputMessage.classList.add(...colorClass.split(' ')); 
            outputMessage.scrollIntoView({ behavior: 'smooth' });

            // Kembalikan tombol ke keadaan semula
            submitButton.textContent = "KIRIMKAN REVIEW & SIMPAN DATA";
            submitButton.disabled = false;
        }

        initializeFirebaseAndAuth();

    </script>
</body>
</html>
